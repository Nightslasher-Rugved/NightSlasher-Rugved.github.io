<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Community Chat</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<br><br>
<a href="index.html" class="btn-small">Home</a>

<div class="chat-container">

  <div class="chat-header">
    <h3>Kunbi Samaj Group</h3>
    <span id="userInfo"></span>
  </div>

  <div class="chat-messages" id="chatBox"></div>

  <form class="chat-input" onsubmit="sendMessage(event)">
    <input type="text" id="message" placeholder="Type a message..." required>
    <button type="submit">Send</button>
  </form>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  query, 
  orderBy,
  deleteDoc, 
  doc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDHHo0tXCOSFU0ZrQ0t1gjM6oPo-i0w2rI",
  authDomain: "kunbi-heritage.firebaseapp.com",
  projectId: "kunbi-heritage",
  storageBucket: "kunbi-heritage.firebasestorage.app",
  messagingSenderId: "973069944697",
  appId: "1:973069944697:web:62e432033a7e975f2f11a8"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const chatBox = document.getElementById("chatBox");
const userInfo = document.getElementById("userInfo");

let currentUser = null;

// ðŸ” Protect Page
onAuthStateChanged(auth, (user) => {

  if (!user) {
    window.location.href = "login.html";
    return;
  }

  currentUser = user;
  userInfo.innerText = "Logged in as: " + user.email;

  loadMessages();
});


// âœ… SEND MESSAGE
window.sendMessage = async function(event) {
  event.preventDefault();

  if (!currentUser) return;

  const input = document.getElementById("message");
  const text = input.value.trim();
  if (text === "") return;

  await addDoc(collection(db, "messages"), {
    name: currentUser.email,
    uid: currentUser.uid,
    text: text,
    time: Date.now()
  });

  input.value = "";
};


// âœ… DELETE MESSAGE (ADMIN EMAIL ONLY)
window.deleteMsg = async function(id) {
  if (currentUser.email === "youradmin@email.com") {
    await deleteDoc(doc(db, "messages", id));
  }
};


window.toggleMenu = function(id) {
  const menu = document.getElementById("menu-" + id);
  menu.style.display = menu.style.display === "none" ? "block" : "none";
};


// âœ… LOAD MESSAGES
function loadMessages() {

  const q = query(collection(db, "messages"), orderBy("time"));

  onSnapshot(q, (snapshot) => {

    chatBox.innerHTML = "";

    snapshot.forEach((docSnap) => {

      const msg = docSnap.data();
      const messageTime = new Date(msg.time).toLocaleTimeString([], {
        hour: '2-digit',
        minute: '2-digit'
      });

      const isAdmin = currentUser.email === "youradmin@email.com";

      chatBox.innerHTML += `
        <div class="card" style="margin-bottom:10px; position:relative;">
          <strong>${msg.name}</strong><br>
          ${msg.text}
          <div style="font-size:12px;color:gray;margin-top:5px;">
            ${messageTime}
          </div>

          ${isAdmin ? `
            <div style="position:absolute; top:10px; right:10px;">
              <span onclick="toggleMenu('${docSnap.id}')" 
                style="cursor:pointer; font-size:18px;">â‹®</span>

              <div id="menu-${docSnap.id}" 
                style="display:none; margin-top:5px; text-align:right;">
                
                <button onclick="deleteMsg('${docSnap.id}')"
                  style="
                    background:#ff4d4d;
                    color:white;
                    border:none;
                    padding:6px 12px;
                    border-radius:15px;
                    cursor:pointer;
                  ">
                  Delete
                </button>

              </div>
            </div>
          ` : ""}

        </div>
      `;
    });

    chatBox.scrollTop = chatBox.scrollHeight;
  });
}

</script>

</body>
</html>
